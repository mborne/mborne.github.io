
<!DOCTYPE html>

<html class="no-js" lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="https://mborne.github.io/outils/docker/bonnes-pratiques/" rel="canonical">
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.6.1, mkdocs-material-9.7.1" name="generator"/>
<title>Docker - Les bonnes pratiques - mborne.github.io</title>
<link href="../../../assets/stylesheets/main.484c7ddc.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect">
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet">
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<link href="../../../assets/css/style.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<!-- Matomo -->
<script>
  var _paq = window._paq = window._paq || [];
  /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="https://stats.quadtreeworld.net/";
    _paq.push(['setTrackerUrl', u+'matomo.php']);
    _paq.push(['setSiteId', '3']);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<!-- End Matomo Code -->
<script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
<script src="../../../js/unpkg.com/d3@7.js" type="text/javascript"></script><script src="../../../js/unpkg.com/markmap-lib@0.18.js" type="text/javascript"></script><script src="../../../js/unpkg.com/markmap-view@0.18.js" type="text/javascript"></script><style type="text/css">div.mkdocs-markmap {
    width: 100%;
    min-height: 1em;
    border: 1px solid grey;
}
.mkdocs-markmap > svg {
    width: 100%;
    height: 100%;
    display: block;
}
</style></head>
<body dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#vue-densemble">
          Aller au contenu
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow" data-md-component="header">
<nav aria-label="En-tête" class="md-header__inner md-grid">
<a aria-label="mborne.github.io" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="mborne.github.io">
<img alt="logo" src="../../../assets/logo-qtw.svg"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            mborne.github.io
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Docker - Les bonnes pratiques
            
          </span>
</div>
</div>
</div>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Rechercher" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Rechercher" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Recherche" class="md-search__options">
<button aria-label="Effacer" class="md-search__icon md-icon" tabindex="-1" title="Effacer" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initialisation de la recherche
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
<div class="md-header__source">
<a class="md-source" data-md-component="source" href="https://github.com/mborne/mborne.github.io" title="Aller au dépôt">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    mborne/mborne.github.io
  </div>
</a>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="mborne.github.io" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="mborne.github.io">
<img alt="logo" src="../../../assets/logo-qtw.svg"/>
</a>
    mborne.github.io
  </label>
<div class="md-nav__source">
<a class="md-source" data-md-component="source" href="https://github.com/mborne/mborne.github.io" title="Aller au dépôt">
<div class="md-source__icon md-icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"></path></svg>
</div>
<div class="md-source__repository">
    mborne/mborne.github.io
  </div>
</a>
</div>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    
  
    Accueil
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../">
<span class="md-ellipsis">
    
  
    Les outils
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../fiches/">
<span class="md-ellipsis">
    
  
    Les fiches
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../veille/">
<span class="md-ellipsis">
    
  
    La veille techno
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../depots/">
<span class="md-ellipsis">
    
  
    Les dépôts
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../mentions-legales/">
<span class="md-ellipsis">
    
  
    Mentions légales
  

    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../cookies/">
<span class="md-ellipsis">
    
  
    Cookies et statistiques
  

    
  </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" hidden="">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table des matières" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table des matières
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#vue-densemble">
<span class="md-ellipsis">
      
        Vue d'ensemble
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#generalites">
<span class="md-ellipsis">
      
        Généralités
      
    </span>
</a>
<nav aria-label="Généralités" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#empaqueter-un-seul-service-par-conteneur">
<span class="md-ellipsis">
      
        Empaqueter un seul service par conteneur
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#faire-en-sorte-quun-conteneur-puisse-etre-recree-sans-perte-de-donnees">
<span class="md-ellipsis">
      
        Faire en sorte qu'un conteneur puisse être recréé sans perte de données
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ne-pas-inclure-des-secrets-dans-les-images">
<span class="md-ellipsis">
      
        Ne pas inclure des secrets dans les images
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#utiliser-le-fichier-dockerignore-pour-exclure-les-fichiers-inutiles-ou-dangereux">
<span class="md-ellipsis">
      
        Utiliser le fichier .dockerignore pour exclure les fichiers inutiles ou dangereux
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#minimiser-la-taille-des-images">
<span class="md-ellipsis">
      
        Minimiser la taille des images
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#minimiser-le-temps-de-construction-des-images">
<span class="md-ellipsis">
      
        Minimiser le temps de construction des images
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#observabilite">
<span class="md-ellipsis">
      
        Observabilité
      
    </span>
</a>
<nav aria-label="Observabilité" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#respecter-le-cadre-pour-les-journaux-applicatif">
<span class="md-ellipsis">
      
        Respecter le cadre pour les journaux applicatif
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#permettre-la-surveillance-de-letat-du-service">
<span class="md-ellipsis">
      
        Permettre la surveillance de l'état du service
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#securite">
<span class="md-ellipsis">
      
        Sécurité
      
    </span>
</a>
<nav aria-label="Sécurité" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ne-pas-executer-nimporte-quoi-ou-nimporte-quelle-image">
<span class="md-ellipsis">
      
        Ne pas exécuter n'importe quoi ou n'importe quelle image
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ne-pas-executer-les-conteneurs-en-tant-quutilisateur-root">
<span class="md-ellipsis">
      
        Ne pas exécuter les conteneurs en tant qu'utilisateur root
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#utiliser-des-ports-non-privilegies-pour-les-services">
<span class="md-ellipsis">
      
        Utiliser des ports non privilégiés pour les services
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#configurer-par-defaut-pour-la-production">
<span class="md-ellipsis">
      
        Configurer par défaut pour la production
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#utiliser-des-conteneurs-avec-un-systeme-de-fichiers-en-lecture-seule">
<span class="md-ellipsis">
      
        Utiliser des conteneurs avec un système de fichiers en lecture seule
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#scanner-regulierement-les-images">
<span class="md-ellipsis">
      
        Scanner régulièrement les images
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#configurer-les-options-de-securite-au-niveau-du-demon">
<span class="md-ellipsis">
      
        Configurer les options de sécurité au niveau du démon
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#se-mefier-des-expositions-de-port">
<span class="md-ellipsis">
      
        Se méfier des expositions de port
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#robustesse">
<span class="md-ellipsis">
      
        Robustesse
      
    </span>
</a>
<nav aria-label="Robustesse" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#utiliser-un-miroir-pour-lacces-aux-images-publiques">
<span class="md-ellipsis">
      
        Utiliser un miroir pour l'accès aux images publiques
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#limiter-lutilisation-des-ressources">
<span class="md-ellipsis">
      
        Limiter l'utilisation des ressources
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#traiter-proprement-les-signaux-sigterm-pour-assurer-des-arrets-gracieux">
<span class="md-ellipsis">
      
        Traiter proprement les signaux SIGTERM pour assurer des arrêts gracieux
      
    </span>
</a>
<nav aria-label="Traiter proprement les signaux SIGTERM pour assurer des arrêts gracieux" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#cas-des-services">
<span class="md-ellipsis">
      
        Cas des services
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cas-des-traitements-longs">
<span class="md-ellipsis">
      
        Cas des traitements longs
      
    </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#cas-particulier-des-images-apache2">
<span class="md-ellipsis">
      
        Cas particulier des images apache2
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#ne-pas-modifier-le-signal-darret-par-defaut">
<span class="md-ellipsis">
      
        Ne pas modifier le signal d'arrêt par défaut
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#divers">
<span class="md-ellipsis">
      
        Divers
      
    </span>
</a>
<nav aria-label="Divers" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ne-pas-gerer-un-proxy-sortant-dans-le-dockerfile">
<span class="md-ellipsis">
      
        Ne pas gérer un proxy sortant dans le Dockerfile
      
    </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#references">
<span class="md-ellipsis">
      
        Références
      
    </span>
</a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<a class="md-content__button md-icon" href="https://github.com/mborne/mborne.github.io/edit/main/docs/outils/docker/bonnes-pratiques/index.md" rel="edit" title="Editer cette page">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"></path></svg>
</a>
<h1 id="docker-les-bonnes-pratiques">Docker - Les bonnes pratiques<a class="headerlink" href="#docker-les-bonnes-pratiques" title="Permanent link">¶</a></h1>
<p>Cette fiche s'efforce de résumer un ensemble de bonnes pratiques classiques (c.f. <a href="#references">références</a>) complétées de recommandations visant entre autres à guider dans la production d'images pouvant être exécutées dans des environnements sécurisés (c.f. <a href="https://kubernetes.io/docs/concepts/security/pod-security-standards/">kubernetes.io - Pod Security Standards</a> et <a href="https://github.com/kyverno/policies/tree/main/pod-security">kyverno/policies - baseline et restricted</a>)</p>
<h2 id="vue-densemble">Vue d'ensemble<a class="headerlink" href="#vue-densemble" title="Permanent link">¶</a></h2>
<div class="language-markmap mkdocs-markmap"><markmap-data encoding="base64" hidden="true">LSBbR8OpbsOpcmFsaXTDqXNdKCNnw6luw6lyYWxpdMOpcykKICAgIC0gW0VtcGFxdWV0ZXIgdW4gc2V1bCBzZXJ2aWNlIHBhciBjb250ZW5ldXJdKCNlbXBhcXVldGVyLXVuLXNldWwtc2VydmljZS1wYXItY29udGVuZXVyKQogICAgLSBbRmFpcmUgZW4gc29ydGUgcXUndW4gY29udGVuZXVyIHB1aXNzZSDDqnRyZSByZWNyw6nDqSBzYW5zIHBlcnRlIGRlIGRvbm7DqWVzXSgjZmFpcmUtZW4tc29ydGUtcXV1bi1jb250ZW5ldXItcHVpc3NlLWV0cmUtcmVjcmVlLXNhbnMtcGVydGUtZGUtZG9ubmVlcykKICAgIC0gW05lIHBhcyBpbmNsdXJlIGRlcyBzZWNyZXRzIGRhbnMgbGVzIGltYWdlc10oI25lLXBhcy1pbmNsdXJlLWRlcy1zZWNyZXRzLWRhbnMtbGVzLWltYWdlcykKICAgIC0gW1V0aWxpc2VyIGxlIGZpY2hpZXIgLmRvY2tlcmlnbm9yZSBwb3VyIGV4Y2x1cmUgbGVzIGZpY2hpZXJzIGludXRpbGVzIG91IGRhbmdlcmV1eF0oI3V0aWxpc2VyLWxlLWZpY2hpZXItZG9ja2VyaWdub3JlLXBvdXItZXhjbHVyZS1sZXMtZmljaGllcnMtaW51dGlsZXMtb3UtZGFuZ2VyZXV4KQogICAgLSBbTWluaW1pc2VyIGxhIHRhaWxsZSBkZXMgaW1hZ2VzXSgjbWluaW1pc2VyLWxhLXRhaWxsZS1kZXMtaW1hZ2VzKQogICAgLSBbTWluaW1pc2VyIGxlIHRlbXBzIGRlIGNvbnN0cnVjdGlvbiBkZXMgaW1hZ2VzXSgjbWluaW1pc2VyLWxlLXRlbXBzLWRlLWNvbnN0cnVjdGlvbi1kZXMtaW1hZ2VzKQotIFtPYnNlcnZhYmlsaXTDqV0oI29ic2VydmFiaWxpdMOpKQogICAgLSBbUmVzcGVjdGVyIGxlIGNhZHJlIHBvdXIgbGVzIGpvdXJuYXV4IGFwcGxpY2F0aWZdKCNyZXNwZWN0ZXItbGUtY2FkcmUtcG91ci1sZXMtam91cm5hdXgtYXBwbGljYXRpZikKICAgIC0gW1Blcm1ldHRyZSBsYSBzdXJ2ZWlsbGFuY2UgZGUgbCfDqXRhdCBkdSBzZXJ2aWNlXSgjcGVybWV0dHJlLWxhLXN1cnZlaWxsYW5jZS1kZS1sZXRhdC1kdS1zZXJ2aWNlKQotIFtTw6ljdXJpdMOpXSgjc8OpY3VyaXTDqSkKICAgIC0gW05lIHBhcyBleMOpY3V0ZXIgbidpbXBvcnRlIHF1b2kgb3UgbidpbXBvcnRlIHF1ZWxsZSBpbWFnZV0oI25lLXBhcy1leGVjdXRlci1uaW1wb3J0ZS1xdW9pLW91LW5pbXBvcnRlLXF1ZWxsZS1pbWFnZSkKICAgIC0gW05lIHBhcyBleMOpY3V0ZXIgbGVzIGNvbnRlbmV1cnMgZW4gdGFudCBxdSd1dGlsaXNhdGV1ciByb290XSgjbmUtcGFzLWV4ZWN1dGVyLWxlcy1jb250ZW5ldXJzLWVuLXRhbnQtcXV1dGlsaXNhdGV1ci1yb290KQogICAgLSBbVXRpbGlzZXIgZGVzIHBvcnRzIG5vbiBwcml2aWzDqWdpw6lzIHBvdXIgbGVzIHNlcnZpY2VzXSgjdXRpbGlzZXItZGVzLXBvcnRzLW5vbi1wcml2aWxlZ2llcy1wb3VyLWxlcy1zZXJ2aWNlcykKICAgIC0gW0NvbmZpZ3VyZXIgcGFyIGTDqWZhdXQgcG91ciBsYSBwcm9kdWN0aW9uXSgjY29uZmlndXJlci1wYXItZGVmYXV0LXBvdXItbGEtcHJvZHVjdGlvbikKICAgIC0gW1V0aWxpc2VyIGRlcyBjb250ZW5ldXJzIGF2ZWMgdW4gc3lzdMOobWUgZGUgZmljaGllcnMgZW4gbGVjdHVyZSBzZXVsZV0oI3V0aWxpc2VyLWRlcy1jb250ZW5ldXJzLWF2ZWMtdW4tc3lzdGVtZS1kZS1maWNoaWVycy1lbi1sZWN0dXJlLXNldWxlKQogICAgLSBbU2Nhbm5lciByw6lndWxpw6hyZW1lbnQgbGVzIGltYWdlc10oI3NjYW5uZXItcmVndWxpZXJlbWVudC1sZXMtaW1hZ2VzKQogICAgLSBbQ29uZmlndXJlciBsZXMgb3B0aW9ucyBkZSBzw6ljdXJpdMOpIGF1IG5pdmVhdSBkdSBkw6ltb25dKCNjb25maWd1cmVyLWxlcy1vcHRpb25zLWRlLXNlY3VyaXRlLWF1LW5pdmVhdS1kdS1kZW1vbikKICAgIC0gW1NlIG3DqWZpZXIgZGVzIGV4cG9zaXRpb25zIGRlIHBvcnRdKCNzZS1tZWZpZXItZGVzLWV4cG9zaXRpb25zLWRlLXBvcnQpCi0gW1JvYnVzdGVzc2VdKCNyb2J1c3Rlc3NlKQogICAgLSBbVXRpbGlzZXIgdW4gbWlyb2lyIHBvdXIgbCdhY2PDqHMgYXV4IGltYWdlcyBwdWJsaXF1ZXNdKCN1dGlsaXNlci11bi1taXJvaXItcG91ci1sYWNjZXMtYXV4LWltYWdlcy1wdWJsaXF1ZXMpCiAgICAtIFtMaW1pdGVyIGwndXRpbGlzYXRpb24gZGVzIHJlc3NvdXJjZXNdKCNsaW1pdGVyLWx1dGlsaXNhdGlvbi1kZXMtcmVzc291cmNlcykKICAgIC0gW1RyYWl0ZXIgcHJvcHJlbWVudCBsZXMgc2lnbmF1eCBTSUdURVJNIHBvdXIgYXNzdXJlciBkZXMgYXJyw6p0cyBncmFjaWV1eF0oI3RyYWl0ZXItcHJvcHJlbWVudC1sZXMtc2lnbmF1eC1zaWd0ZXJtLXBvdXItYXNzdXJlci1kZXMtYXJyZXRzLWdyYWNpZXV4KQogICAgLSBbTmUgcGFzIG1vZGlmaWVyIGxlIHNpZ25hbCBkJ2FycsOqdCBwYXIgZMOpZmF1dF0oI25lLXBhcy1tb2RpZmllci1sZS1zaWduYWwtZGFycmV0LXBhci1kZWZhdXQpCi0gW0RpdmVyc10oI2RpdmVycykKICAgIC0gW05lIHBhcyBnw6lyZXIgdW4gcHJveHkgc29ydGFudCBkYW5zIGxlIERvY2tlcmZpbGVdKCNuZS1wYXMtZ2VyZXItdW4tcHJveHktc29ydGFudC1kYW5zLWxlLWRvY2tlcmZpbGUp</markmap-data></div>
<hr/>
<h2 id="generalites">Généralités<a class="headerlink" href="#generalites" title="Permanent link">¶</a></h2>
<h3 id="empaqueter-un-seul-service-par-conteneur">Empaqueter un seul service par conteneur<a class="headerlink" href="#empaqueter-un-seul-service-par-conteneur" title="Permanent link">¶</a></h3>
<ul>
<li>Appliquer tant que possible la règle <strong>un conteneur = un service</strong>.</li>
<li>Éviter par exemple de produire une image incluant une application et une instance PostgreSQL.</li>
<li>Utiliser plutôt un fichier docker-compose.yaml pour faciliter le démarrage de l'application :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">app</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp:latest</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"5000:5000"</span>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres:15</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pg-data:/var/lib/postgresql/data</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">pg-data</span><span class="p">:</span>
</code></pre></div>
<details class="info">
<summary>Cas des utilitaires</summary>
<ul>
<li>Il est parfois commode d'inclure dans une même image un service et les utilitaires de ce service (ex : <a href="https://www.postgresql.org/docs/current/app-pgdump.html">pg_dump</a> et <a href="https://www.postgresql.org/docs/current/app-psql.html">psql</a> dans l'<a href="https://hub.docker.com/_/postgres">image officielle PostgreSQL</a>).</li>
<li>Il est toutefois possible de produire plusieurs versions de l'image (ex : une image alégée pour l'exécution du service et une image complète pour les jobs)</li>
</ul>
</details>
<h3 id="faire-en-sorte-quun-conteneur-puisse-etre-recree-sans-perte-de-donnees">Faire en sorte qu'un conteneur puisse être recréé sans perte de données<a class="headerlink" href="#faire-en-sorte-quun-conteneur-puisse-etre-recree-sans-perte-de-donnees" title="Permanent link">¶</a></h3>
<ul>
<li>Préférer si possible l'utilisation de services dédiés au stockage (base de données, stockage objet,...) pour les données applicatives plutôt que l'utilisation de fichiers.</li>
<li>Identifier clairement les dossiers contenant des données persistantes dans le cas contraire (ex : <code>/var/lib/postgresql/data</code> pour PostgreSQL).</li>
<li><strong>Utiliser des volumes pour la persistence des données</strong> :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">db</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql:5.7</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db-data:/var/lib/mysql</span>
<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">db-data</span><span class="p">:</span>
</code></pre></div>
<h3 id="ne-pas-inclure-des-secrets-dans-les-images">Ne pas inclure des secrets dans les images<a class="headerlink" href="#ne-pas-inclure-des-secrets-dans-les-images" title="Permanent link">¶</a></h3>
<ul>
<li><strong>Ne pas inclure les paramètres pour l'exécution dans l'image</strong><ul>
<li>Utiliser plutôt des variables d'environnement (ex : <code>DATABASE_URL</code> ou <code>DB_PASSWORD</code>, c.f. <a href="https://12factor.net/config">12 facteurs - III. Configuration - Stockez la configuration dans l’environnement</a>)</li>
</ul>
</li>
<li><strong>Ne pas inclure le dossier <code>.git</code> dans les images</strong> :<ul>
<li>Inclure <code>.git</code> dans <code>.dockerignore</code>.</li>
<li>Éviter <code>COPY . .</code>.</li>
</ul>
</li>
<li><strong>Ne pas utiliser <code>--build-arg</code> pour fournir des secrets à la construction</strong>.<ul>
<li>Savoir que <code>docker image history ...</code> permet de récupérer les secrets correspondants.</li>
<li>Éviter les dépendances privées (git, npm, PHP composer...) impliquant une authentification (donc un risque d'inclure un secret dans l'image)</li>
<li>Consulter <a href="https://docs.docker.com/build/building/secrets/">docs.docker.com - Build secrets</a> si vous ne pouvez vraiment pas éviter de telles dépendances...</li>
</ul>
</li>
<li><strong>Veiller à ne pas inclure un fichier <code>.env</code> incluant des secrets utilisés pour le développement dans l'image</strong> :<ul>
<li>Option 1) Si le framework propose de gérer de tels fichiers à la racine du projet (ex : PHP Symfony), être très attentif à leurs présences dans <code>.dockerignore</code> et <code>.gitignore</code>.</li>
<li>Option 2) Pour limiter réellement le risque d'inclure de tels fichiers dans une image, stocker et chiffrer ces secrets loin du Dockerfile et des dépôts GIT (ex : une partition chiffrée).</li>
</ul>
</li>
</ul>
<h3 id="utiliser-le-fichier-dockerignore-pour-exclure-les-fichiers-inutiles-ou-dangereux">Utiliser le fichier .dockerignore pour exclure les fichiers inutiles ou dangereux<a class="headerlink" href="#utiliser-le-fichier-dockerignore-pour-exclure-les-fichiers-inutiles-ou-dangereux" title="Permanent link">¶</a></h3>
<ul>
<li>Ajouter un fichier <code>.dockerignore</code> pour exclure les fichiers inutiles ou dangereux (<code>.git</code>) :</li>
</ul>
<div class="highlight"><pre><span></span><code>node_modules
.git
*.log
*.md
.dockerignore
</code></pre></div>
<h3 id="minimiser-la-taille-des-images">Minimiser la taille des images<a class="headerlink" href="#minimiser-la-taille-des-images" title="Permanent link">¶</a></h3>
<ul>
<li><strong>Installer uniquement ce qui est nécessaire</strong>.</li>
<li><strong>Comprendre et exploiter les mécanismes de couches</strong> dans les images (<code>docker image history mon-image</code>)</li>
<li><strong>Grouper les instructions</strong> pour supprimer les fichiers temporaires après installation des dépendances :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># Supprimer les fichiers temporaires après installation des dépendances</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span>
<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>wget<span class="w"> </span>gdal-bin<span class="w"> </span><span class="se">\</span>
<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*
</code></pre></div>
<ul>
<li><strong>Ordonner les instructions</strong> pour profiter de la mise en cache :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># CONTRE-EXEMPLE</span>

<span class="c"># en ajoutant le code avant l'installation de curl...</span>
<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>.

<span class="c"># ... curl est installé à chaque mise à jour du code</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span>
<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span>curl<span class="w"> </span><span class="se">\</span>
<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*
</code></pre></div>
<ul>
<li><strong>Utiliser des constructions multi-étapes</strong> (<em>multi-stage builds</em>) pour éviter de conserver les éléments relatifs à la construction :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># Etape 1 : Construire le site statique</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">node:20</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">builder</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>
<span class="k">COPY</span><span class="w"> </span>package*.json<span class="w"> </span>./
<span class="k">RUN</span><span class="w"> </span>npm<span class="w"> </span>install
<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>.
<span class="k">RUN</span><span class="w"> </span>npm<span class="w"> </span>run<span class="w"> </span>build

<span class="c"># Etape 2 : Copier le résultat de la construction dans une image nginx pour l'exécution</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">nginx:alpine</span>
<span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>builder<span class="w"> </span>/app/build<span class="w"> </span>/usr/share/nginx/html
</code></pre></div>
<h3 id="minimiser-le-temps-de-construction-des-images">Minimiser le temps de construction des images<a class="headerlink" href="#minimiser-le-temps-de-construction-des-images" title="Permanent link">¶</a></h3>
<ul>
<li><strong>Comprendre et exploiter les mécanismes de cache dans la construction</strong> :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># Par exemple, pour ne pas exécuter npm install à chaque changement dans src/ :</span>
<span class="c"># 1) installer les dépendances</span>
<span class="k">COPY</span><span class="w"> </span>package.json<span class="w"> </span>package-lock.json<span class="w"> </span>.
<span class="k">RUN</span><span class="w"> </span>npm<span class="w"> </span>install<span class="w"> </span>
<span class="c"># 2) ajouter les fichiers dynamiques dans un second temps</span>
<span class="k">COPY</span><span class="w"> </span>src/<span class="w"> </span>src
</code></pre></div>
<h2 id="observabilite">Observabilité<a class="headerlink" href="#observabilite" title="Permanent link">¶</a></h2>
<h3 id="respecter-le-cadre-pour-les-journaux-applicatif">Respecter le cadre pour les journaux applicatif<a class="headerlink" href="#respecter-le-cadre-pour-les-journaux-applicatif" title="Permanent link">¶</a></h3>
<ul>
<li>Écrire les journaux dans les flux standard (stdout et stderr) en utilisant des formats standards (nginx, apache2, json,...).</li>
<li>Rediriger les écritures dans des fichiers dans ces flux standard s'il n'est pas possible d'adapter le code en ce sens :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># Exemple avec nginx</span>
<span class="k">RUN</span><span class="w"> </span>ln<span class="w"> </span>-sf<span class="w"> </span>/dev/stdout<span class="w"> </span>/var/log/nginx/access.log<span class="w"> </span><span class="se">\</span>
<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ln<span class="w"> </span>-sf<span class="w"> </span>/dev/stderr<span class="w"> </span>/var/log/nginx/error.log
</code></pre></div>
<h3 id="permettre-la-surveillance-de-letat-du-service">Permettre la surveillance de l'état du service<a class="headerlink" href="#permettre-la-surveillance-de-letat-du-service" title="Permanent link">¶</a></h3>
<ul>
<li>Prévoir un mécanisme pour la surveillance de l'état du conteneur (ex : URL <code>/health</code>)</li>
<li>Envisager <sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> la déclaration du HEALTHCHECK correspondant dans le conteneur :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># Ajouter un healthcheck</span>
<span class="k">HEALTHCHECK</span><span class="w"> </span><span class="k">CMD</span><span class="w"> </span>curl<span class="w"> </span>--fail<span class="w"> </span>http://localhost:8080/health<span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">exit</span><span class="w"> </span><span class="m">1</span>
</code></pre></div>
<h2 id="securite">Sécurité<a class="headerlink" href="#securite" title="Permanent link">¶</a></h2>
<h3 id="ne-pas-executer-nimporte-quoi-ou-nimporte-quelle-image">Ne pas exécuter n'importe quoi ou n'importe quelle image<a class="headerlink" href="#ne-pas-executer-nimporte-quoi-ou-nimporte-quelle-image" title="Permanent link">¶</a></h3>
<p>Cette précaution de base qui s'applique à d'autres outils susceptibles d'exécuter du code malveillant (npm, PHP composer,...) s'applique évidemment aussi pour docker :</p>
<ul>
<li>Utiliser des <strong>images officielles</strong> ou des <strong>images d'éditeurs reconnus</strong>.</li>
<li>Installer des composants en provenance d'éditeurs reconnus dans vos images.</li>
</ul>
<h3 id="ne-pas-executer-les-conteneurs-en-tant-quutilisateur-root">Ne pas exécuter les conteneurs en tant qu'utilisateur root<a class="headerlink" href="#ne-pas-executer-les-conteneurs-en-tant-quutilisateur-root" title="Permanent link">¶</a></h3>
<ul>
<li>Utiliser un <strong>utilisateur dédié à l'application</strong> pour l'exécution :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># Exemple avec NodeJS où l'image inclue un utilisateur "node" (uid=1000)</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">node:20</span>
<span class="k">WORKDIR</span><span class="w"> </span><span class="s">/app</span>
<span class="k">COPY</span><span class="w"> </span>.<span class="w"> </span>.
<span class="k">RUN</span><span class="w"> </span>npm<span class="w"> </span>install
<span class="k">USER</span><span class="w"> </span><span class="s">node</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">"node"</span><span class="p">,</span><span class="w"> </span><span class="s2">"app.js"</span><span class="p">]</span>
</code></pre></div>
<ul>
<li>Prévoir des <strong>volumes avec les permissions adaptées</strong> dans l'image :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># Exemple de dossier /app/data modifiable à l'exécution</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">DATA_DIR</span><span class="o">=</span>/app/data
<span class="k">RUN</span><span class="w"> </span>mkdir<span class="w"> </span>/app/data<span class="w"> </span><span class="se">\</span>
<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>chown<span class="w"> </span>-R<span class="w"> </span>node:node/app/data
<span class="k">VOLUME</span><span class="w"> </span><span class="s">/app/data</span>
</code></pre></div>
<h3 id="utiliser-des-ports-non-privilegies-pour-les-services">Utiliser des ports non privilégiés pour les services<a class="headerlink" href="#utiliser-des-ports-non-privilegies-pour-les-services" title="Permanent link">¶</a></h3>
<div class="admonition info">
<p class="admonition-title">Pourquoi?</p>
<p>L'utilisation du port 80 peut bloquer l'activation des options de sécurité <code>runAsNonRoot: true</code> et <code>runAsUser: 1000</code> en contexte Kubernetes (ou induire des configurations supplémentaires, c.f. <a href="https://kubernetes.io/docs/tasks/administer-cluster/sysctl-cluster/#safe-and-unsafe-sysctls">kubernetes.io - Safe and Unsafe Sysctls - net.ipv4.ip_unprivileged_port_start</a>)</p>
</div>
<ul>
<li>Pour vos application, <strong>utiliser des ports non privilégiés pour vos applications (&gt;1024)</strong> (ex : <code>APP_PORT=3000</code>)</li>
<li>Pour les services tiers, utiliser des images traitant cette problématique (ex : <a href="https://hub.docker.com/_/nginx">nginx</a> -&gt; <a href="https://hub.docker.com/r/nginxinc/nginx-unprivileged">nginxinc/nginx-unprivileged</a>)</li>
</ul>
<h3 id="configurer-par-defaut-pour-la-production">Configurer par défaut pour la production<a class="headerlink" href="#configurer-par-defaut-pour-la-production" title="Permanent link">¶</a></h3>
<ul>
<li>Configurer les <strong>variables d'environnement avec des valeurs par défaut adaptées pour la production</strong> au niveau de l'image :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># utiliser la version optimisée par défaut...</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">APP_ENV</span><span class="o">=</span>production
<span class="c"># ne pas activer des fonctionnalités de debug dangereuse par défaut</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">APP_DEBUG</span><span class="o">=</span><span class="nb">false</span>
<span class="c"># ne pas produire inutilement trop de logs</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">LOG_LEVEL</span><span class="o">=</span>INFO
<span class="c"># ...</span>
</code></pre></div>
<ul>
<li>Utiliser au besoin des valeurs adaptées pour le DEV au niveau du fichier docker-compose.yaml correspondant :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">app</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="nt">APP_ENV</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${APP_ENV:-dev}</span>
<span class="w">      </span><span class="nt">APP_DEBUG</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${APP_DEBUG:-true}</span>
<span class="w">      </span><span class="nt">LOG_LEVEL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">${LOG_LEVEL:-DEBUG}</span>
</code></pre></div>
<h3 id="utiliser-des-conteneurs-avec-un-systeme-de-fichiers-en-lecture-seule">Utiliser des conteneurs avec un système de fichiers en lecture seule<a class="headerlink" href="#utiliser-des-conteneurs-avec-un-systeme-de-fichiers-en-lecture-seule" title="Permanent link">¶</a></h3>
<p>Avoir un conteneur avec un <strong>système de fichier en lecture seule</strong> (<a href="https://docs.docker.com/reference/cli/docker/container/run/#read-only">docker run --read-only</a>, <code>readOnlyRootFilesystem: true</code> avec K8S) présente différents avantages :</p>
<ul>
<li>Bloquer les modifications sur l'application en cas d'attaque.</li>
<li>Identifier les dossiers contenant des données dynamiques (et pouvoir <strong>se protéger contre un risque de full</strong>).</li>
</ul>
<p>Pour permettre l'activation de cette option :</p>
<ul>
<li><strong>Identifier les dossiers dynamiques</strong> pour lesquels il conviendra de monter des volumes (ex : <code>/app/data</code>, <code>/app/config</code>,...)</li>
<li><strong>Ne pas inclure du contenu statique dans ces dossiers dynamique</strong> (ex : un fichier <code>/app/config/runtime.conf</code> est généré au démarrage et <code>/app/config/static.conf</code> est inclu dans l'image <sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup>)</li>
</ul>
<h3 id="scanner-regulierement-les-images">Scanner régulièrement les images<a class="headerlink" href="#scanner-regulierement-les-images" title="Permanent link">¶</a></h3>
<p>Plusieurs options sont possibles :</p>
<ul>
<li>Utiliser les scanners de vulnérabilité <strong>au niveau des dépôts d'images</strong> (ex : DockerHub, GitHub Container Registry, Harbor,...).</li>
<li>Utiliser des outils tels <a href="../../trivy/">Trivy</a> (qui est utilisé par Harbor) ou <a href="https://github.com/quay/clair">Clair</a> <strong>en local et au niveau CI/CD</strong> (GitHub actions, GitLab-CI,...).</li>
</ul>
<h3 id="configurer-les-options-de-securite-au-niveau-du-demon">Configurer les options de sécurité au niveau du démon<a class="headerlink" href="#configurer-les-options-de-securite-au-niveau-du-demon" title="Permanent link">¶</a></h3>
<div class="admonition info">
<p class="admonition-title">Principe</p>
<p>Plusieurs options de sécurité limitent les risques liés à l'utilisation de docker. Par exemple, l'option <a href="https://docs.docker.com/engine/security/userns-remap/">userns-remap</a> permet d'associer l'utilisateur "root" au niveau des conteneurs à un utilisateur non root sur le hôte.</p>
</div>
<ul>
<li>Configurer le démon docker en activant les options de sécurité.</li>
<li>Vérifier la configuration du démon docker à l'aide d'outils tel <a href="https://hub.docker.com/r/docker/docker-bench-security">docker-bench-security</a>.</li>
</ul>
<h3 id="se-mefier-des-expositions-de-port">Se méfier des expositions de port<a class="headerlink" href="#se-mefier-des-expositions-de-port" title="Permanent link">¶</a></h3>
<div class="admonition warning">
<p class="admonition-title">Mise en garde</p>
<p>Si vous utiliser docker <strong>sur une machine exposée</strong>, vous devrez <strong>éviter les expositions sur des ports</strong> (ex : <code>-p 5432:5432</code> -&gt; <code>-p 127.0.0.1:5432:5432</code> si c'est vraiment nécessaire). En effet, <span style="font-weight: bold; color: red">docker manipule iptables et les règles de pare-feu local que vous configurez par exemple avec <a href="../../ufw/">UFW</a> seront tout simplement ignorées.</span>.</p>
</div>
<ul>
<li>Utiliser des réseaux pour la communication entre les conteneurs.</li>
<li>Accéder au besoin aux services non exposés depuis l'hôte :<ul>
<li>Via les IP des conteneurs (<code>docker inspect ...</code>).</li>
<li>En mappant les ports uniquement sur l'hôte (ex : <code>-p 127.0.0.1:9200:9200</code>)</li>
</ul>
</li>
<li>Utiliser un <strong>reverse proxy</strong> tel <a href="https://github.com/traefik/traefik#overview">Traefik</a> <strong>pour limiter le nombre de port à exposer</strong> et pour avoir de jolies URL (ex : https://opensearch.dev.localhost).</li>
</ul>
<h2 id="robustesse">Robustesse<a class="headerlink" href="#robustesse" title="Permanent link">¶</a></h2>
<h3 id="utiliser-un-miroir-pour-lacces-aux-images-publiques">Utiliser un miroir pour l'accès aux images publiques<a class="headerlink" href="#utiliser-un-miroir-pour-lacces-aux-images-publiques" title="Permanent link">¶</a></h3>
<div class="admonition warning">
<p class="admonition-title">Mise en garde</p>
<p>Utiliser un miroir pour l'accès aux images DockerHub est important pour <strong>éviter d'atteindre la limite de pull sur DockerHub</strong> (c.f. <a href="https://docs.docker.com/docker-hub/download-rate-limit/">Docker Hub rate limit</a> )</p>
</div>
<ul>
<li><strong>Configurer si possible l'utilisation transparente d'un miroir au niveau du démon docker</strong> (ou containerd).</li>
<li><strong>Modifier le nom des images pour l'exécution</strong> dans le cas où cette configuration n'est pas traitée (<code>nginx:latest</code> -&gt; <code>dockerhub-proxy.exemple.fr/library/nginx:latest</code>).</li>
<li><strong>Permettre l'utilisation du miroir pour la construction dans le fichier Dockerfile</strong> (<code>--build-arg registry=dockerhub-proxy.exemple.fr</code>) :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">ARG</span><span class="w"> </span><span class="nv">registry</span><span class="o">=</span>docker.io
<span class="k">FROM</span><span class="w"> </span><span class="s">${registry}/library/ubuntu:22.04</span>
</code></pre></div>
<h3 id="limiter-lutilisation-des-ressources">Limiter l'utilisation des ressources<a class="headerlink" href="#limiter-lutilisation-des-ressources" title="Permanent link">¶</a></h3>
<p>Pour <strong>éviter de consommer toutes les ressources de l'hôte</strong> et préparer des déploiements en environnement de production (ex : Kubernetes) où la consommation RAM / CPU doit être maîtrisée et déclarée pour assurer la stabilité :</p>
<ul>
<li>Configurer les limites de consommation CPU et RAM :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">app</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp:latest</span>
<span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">        </span><span class="nt">limits</span><span class="p">:</span>
<span class="w">          </span><span class="nt">cpus</span><span class="p">:</span><span class="w"> </span><span class="s">"0.5"</span>
<span class="w">          </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">"512M"</span>
</code></pre></div>
<h3 id="traiter-proprement-les-signaux-sigterm-pour-assurer-des-arrets-gracieux">Traiter proprement les signaux SIGTERM pour assurer des arrêts gracieux<a class="headerlink" href="#traiter-proprement-les-signaux-sigterm-pour-assurer-des-arrets-gracieux" title="Permanent link">¶</a></h3>
<h4 id="cas-des-services">Cas des services<a class="headerlink" href="#cas-des-services" title="Permanent link">¶</a></h4>
<blockquote>
<p>En substance, la commande <code>docker stop mon-conteneur -t 600</code> ne doit pas mettre 10 minutes. Si c'est le cas, l'application ne s'arrête pas proprement lorsqu'elle reçoit un signal d'arrêt (SIGTERM) et docker finit par procéder à un arrêt brutal. Il en sera de même en environnement Kubernetes où devoir attendre 60 secondes pour que le conteneur s'arrête sera problématique.</p>
</blockquote>
<ul>
<li>Arrêter proprement le service en cas de réception d'un message SIGTERM :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="cm">/*</span>
<span class="cm"> * Exemple avec Node.js et Express</span>
<span class="cm"> * @see https://expressjs.com/en/advanced/healthcheck-graceful-shutdown.html</span>
<span class="cm"> */</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">();</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mf">3000</span><span class="p">);</span>

<span class="nx">process</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'SIGTERM'</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">debug</span><span class="p">(</span><span class="s1">'SIGTERM signal received: closing HTTP server'</span><span class="p">);</span>
<span class="w">  </span><span class="nx">server</span><span class="p">.</span><span class="nx">close</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">debug</span><span class="p">(</span><span class="s1">'HTTP server closed'</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">});</span>
</code></pre></div>
<h4 id="cas-des-traitements-longs">Cas des traitements longs<a class="headerlink" href="#cas-des-traitements-longs" title="Permanent link">¶</a></h4>
<blockquote>
<p>Pour <strong>les traitements longs</strong>, traiter SIGTERM sera synonyme de <strong>se mettre en capacité de recommencer ou de poursuivre le traitement</strong> s'il doit être interrompu pour une raison ou une autre (ex : redémarrage d'une machine, maintenance sur un noeud Kubernetes, libération d'une instance spot,...).</p>
</blockquote>
<ul>
<li>Écouter et faire suivre au besoin les messages SIGTERM (1)</li>
<li>Utiliser une stratégie adaptée au contexte pour permettre la reprise du traitement :<ul>
<li>Remettre en pile le message correspondant au traitement réalisé.</li>
<li>Remettre l'état d'un traitement <code>PROCESSING</code> à <code>PENDING</code> pour redémarrage.</li>
<li>...</li>
</ul>
</li>
</ul>
<blockquote>
<p>(1) Pour les scripts Bash, voir <a href="https://www.baeldung.com/linux/bash-signal-handling">www.baeldung.com - Handling Signals in Bash Script</a> (commande <code>trap</code>) et <a href="https://www.baeldung.com/linux/exec-command-in-shell-script">www.baeldung.com - The Uses of the Exec Command</a> (approche <code>exec</code>)</p>
</blockquote>
<h4 id="cas-particulier-des-images-apache2">Cas particulier des images apache2<a class="headerlink" href="#cas-particulier-des-images-apache2" title="Permanent link">¶</a></h4>
<blockquote>
<p>Pour vous éviter de passer des heures à vous demander pourquoi les scripts bash et PHP intégrés dans une image ne reçoivent pas le signal SIGTERM...</p>
</blockquote>
<ul>
<li>Savoir que dans le cas d'images intégrant le server apache2 (ex : <a href="https://hub.docker.com/layers/library/php/8.3-apache/images/sha256-20a5a87a4752077ff5dc3621a1c107295d6c976e09e95aa5f8fa369471922599?context=explore">php:8.3-apache</a>), le signal SIGTERM est parfois remplacé par SIGWINCH :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">STOPSIGNAL</span><span class="w"> </span><span class="s">SIGWINCH</span>
</code></pre></div>
<h3 id="ne-pas-modifier-le-signal-darret-par-defaut">Ne pas modifier le signal d'arrêt par défaut<a class="headerlink" href="#ne-pas-modifier-le-signal-darret-par-defaut" title="Permanent link">¶</a></h3>
<ul>
<li>Ne pas utiliser le signal par défaut pour empaqueter une application qui écoute l'événement SIGWINCH (changement de taille de fenêtre) plutôt que l'événement SIGTERM :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># mauvaise pratique!</span>
<span class="k">STOPSIGNAL</span><span class="w"> </span><span class="s">SIGWINCH</span>
</code></pre></div>
<ul>
<li>Adapter plutôt le signal à l'aide d'un script bash :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># Version revisitée de https://github.com/docker-library/php/blob/master/8.3/bullseye/apache/apache2-foreground</span>

<span class="c1"># Start apache forwarding SIGINT and SIGTERM to SIGWINCH</span>
<span class="nv">APACHE2_PID</span><span class="o">=</span><span class="s2">""</span>
<span class="k">function</span><span class="w"> </span>stop_apache<span class="o">()</span>
<span class="o">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>!<span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="nv">$APACHE2_PID</span><span class="s2">"</span><span class="w"> </span><span class="o">]</span><span class="p">;</span>
<span class="w">    </span><span class="k">then</span>
<span class="w">        </span><span class="nb">kill</span><span class="w"> </span>-s<span class="w"> </span>WINCH<span class="w"> </span><span class="nv">$APACHE2_PID</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>

<span class="nb">trap</span><span class="w"> </span>stop_apache<span class="w"> </span>SIGINT<span class="w"> </span>SIGTERM<span class="w"> </span>SIGWINCH

apache2<span class="w"> </span>-DFOREGROUND<span class="w"> </span><span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span><span class="w"> </span><span class="p">&amp;</span>
<span class="nv">APACHE2_PID</span><span class="o">=</span><span class="nv">$!</span>
<span class="nb">wait</span><span class="w"> </span><span class="nv">$APACHE2_PID</span>
</code></pre></div>
<h2 id="divers">Divers<a class="headerlink" href="#divers" title="Permanent link">¶</a></h2>
<h3 id="ne-pas-gerer-un-proxy-sortant-dans-le-dockerfile">Ne pas gérer un proxy sortant dans le Dockerfile<a class="headerlink" href="#ne-pas-gerer-un-proxy-sortant-dans-le-dockerfile" title="Permanent link">¶</a></h3>
<ul>
<li>Ne pas inclure des éléments relatifs à l'utilisation d'un proxy sortant dans le fichier <code>Dockerfile</code> :</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c"># MAUVAISE PRATIQUE :</span>
<span class="k">ENV</span><span class="w"> </span><span class="nv">HTTP_PROXY</span><span class="o">=</span>http://proxy.devinez.fr:3128
<span class="k">ENV</span><span class="w"> </span><span class="nv">HTTPS_PROXY</span><span class="o">=</span>http://proxy.devinez.fr:3128
</code></pre></div>
<ul>
<li><a href="https://mborne.github.io/fiches/proxy-sortant/proxy-docker/#construire-les-images-en-specifiant-le-proxy-avec-des-arguments-de-construction">Construire les images en spécifiant le proxy avec des arguments de construction</a></li>
<li><a href="https://mborne.github.io/fiches/proxy-sortant/proxy-docker/#demarrer-les-conteneurs-en-specifiant-le-proxy-avec-des-variables-denvironnement">Démarrer les conteneurs en spécifiant le proxy avec des variables d'environnement</a></li>
</ul>
<h2 id="references">Références<a class="headerlink" href="#references" title="Permanent link">¶</a></h2>
<ul>
<li><a href="https://cloud.google.com/solutions/best-practices-for-building-containers?hl=fr">cloud.google.com - Bonnes pratiques en matière de création de conteneurs</a><ul>
<li><a href="https://cloud.google.com/solutions/best-practices-for-building-containers?hl=fr#signal-handling">Traiter correctement le PID 1, le traitement de signal et les processus zombie</a></li>
<li><a href="https://cloud.google.com/solutions/best-practices-for-building-containers?hl=fr#optimize-for-the-docker-build-cache">Optimiser les conteneurs pour le cache de création de Docker</a></li>
<li><a href="https://cloud.google.com/solutions/best-practices-for-building-containers?hl=fr#remove_unnecessary_tools">Supprimer les outils inutiles</a></li>
<li><a href="https://cloud.google.com/solutions/best-practices-for-building-containers?hl=fr#build-the-smallest-image-possible">Créer la plus petite image possible</a></li>
<li><a href="https://cloud.google.com/solutions/best-practices-for-building-containers?hl=fr#use-vulnerability-scanning">Utiliser l'analyse des failles dans Container Registry</a></li>
<li><a href="https://cloud.google.com/solutions/best-practices-for-building-containers?hl=fr#properly_tag_your_images">Ajouter des tags pertinents aux images</a></li>
<li><a href="https://cloud.google.com/solutions/best-practices-for-building-containers?hl=fr#carefully_consider_whether_to_use_a_public_image">Envisager sérieusement l'utilisation d'une image publique</a></li>
</ul>
</li>
<li><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/">docs.docker.com - Best practices for writing Dockerfiles</a><ul>
<li><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#decouple-applications">Decouple applications</a> : Empaqueter une seule application par conteneur</li>
<li><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#dont-install-unnecessary-packages">Don’t install unnecessary packages</a> : Installer uniquement les packages nécessaires dans les images</li>
<li><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#create-ephemeral-containers">Create ephemeral containers</a> : Faire en sorte qu'un conteneur puisse être recréé sans perte de données (volumes nommés)</li>
<li><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#understand-build-context">Understand build context</a> : Comprendre que les fichiers du contexte de construction sont envoyés au démon docker.</li>
<li><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#exclude-with-dockerignore">Exclude with .dockerignore</a> : Exclure des fichiers lors de la construction de l'image docker à l'aide de <code>.dockerignore</code></li>
<li><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#use-multi-stage-builds">Use multi-stage builds</a></li>
<li><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#minimize-the-number-of-layers">Minimize the number of layers</a> : Limiter le nombre de couches dans l'image en regroupant les commandes</li>
<li><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#leverage-build-cache">Leverage build cache</a> : Comprendre les mécanismes de cache de construction pour mieux les exploiter</li>
<li><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#pipe-dockerfile-through-stdin">Pipe Dockerfile through stdin</a> : Envoyer directement le contenu <code>Dockerfile</code> à via stdin quand son contenu est généré.</li>
<li><a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#sort-multi-line-arguments">Sort multi-line arguments</a> : Organiser les commandes sur plusieurs lignes pour faciliter la relecture et la maintenance</li>
</ul>
</li>
<li><a href="https://cyber.gouv.fr/publications/recommandations-de-securite-relatives-au-deploiement-de-conteneurs-docker">cyber.gouv.fr - ANSSI - Recommandations de sécurité relatives au déploiement de conteneurs Docker</a> qui <strong>aborde plus en détail les aspects systèmes</strong> que cette fiche où nous nous concentrons sur les éléments structurants dans la conception des applications et la création de conteneur.</li>
</ul>
<div class="footnote">
<hr/>
<ol>
<li id="fn:1">
<p>Cette pratique n'est pas forcément très répandue dans les images usuelles. Elle est à articuler avec l'utilisation des <a href="https://kubernetes.io/fr/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">Liveness, Readiness et Startup Probes</a> si vous utilisez Kubernetes. <a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
<li id="fn:2">
<p>Avec Kubernetes et l'option <code>readOnlyRootFilesystem: true</code>, permettre la génération au démarrage d'un fichier <code>/app/config/params.yaml</code> sans vider <code>/app/config</code> sera délicat. Contrairement au cas docker où l'on utilisera un volume nommé, un volume <code>emptyDir</code> monté sur <code>/app/config</code> ne conservera pas le contenu original de l'image. <a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">↩</a></p>
</li>
</ol>
</div>
<aside class="md-source-file">
<span class="md-source-file__fact">
<span class="md-icon" title="Dernière mise à jour">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg>
</span>
<span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="13 février 2026 00:09:29 UTC">13 février 2026</span>
</span>
</aside>
</article>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["content.action.edit"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copi\u00e9 dans le presse-papier", "clipboard.copy": "Copier dans le presse-papier", "search.result.more.one": "1 de plus sur cette page", "search.result.more.other": "# de plus sur cette page", "search.result.none": "Aucun document trouv\u00e9", "search.result.one": "1 document trouv\u00e9", "search.result.other": "# documents trouv\u00e9s", "search.result.placeholder": "Taper pour d\u00e9marrer la recherche", "search.result.term.missing": "Non trouv\u00e9", "select.version": "S\u00e9lectionner la version"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
<script src="../../../assets/js/main.js"></script>
<script type="text/javascript">(function initializeMarkmap() {
    const transformer = new markmap.Transformer();
    const preloadScripts = transformer.plugins
        .flatMap((plugin) => plugin.config?.preloadScripts || [])
        .map((item) => transformer.resolveJS(item));
    const assets = transformer.getAssets();
    const loading = Promise.all([
        assets.styles && markmap.loadCSS(assets.styles),
        markmap.loadJS([...preloadScripts, ...assets.scripts]),
    ]);

    function parseData(content) {
        const { root, frontmatter } = transformer.transform(content);
        let options = markmap.deriveOptions(frontmatter?.markmap);
        options = Object.assign(
            {
                fitRatio: 0.85,
            },
            options
        );
        return { root, options };
    }

    function resetMarkmap(m, el) {
        if (!m.state.rect) return;
        const { x1, y1, x2, y2 } = m.state.rect;
        const height = (el.offsetWidth / (x2 - x1)) * (y2 - y1);
        el.style.height = height + "px";
        m.fit();
    }

    function decodeBase64(encoded) {
        const binary = atob(encoded);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < bytes.length; i++) {
            bytes[i] = binary.charCodeAt(i);
        }
        return new TextDecoder().decode(bytes);
    }

    function renderMarkmap(el) {
        const dataEl = el.querySelector("markmap-data");
        if (!dataEl) return;
        let content = el.textContent;
        if (dataEl.getAttribute("encoding") === "base64") {
            content = decodeBase64(content);
        }
        el.innerHTML = "<svg>";
        svg = el.firstChild;
        const { root, options } = parseData(content);
        const m = markmap.Markmap.create(svg, options);
        m.setData(root);
        requestAnimationFrame(() => {
            resetMarkmap(m, el);
        });
    }

    function updateMarkmaps(node) {
        for (const el of node.querySelectorAll(".mkdocs-markmap")) {
            renderMarkmap(el);
        }
    }

    loading.then(() => {
        const observer = new MutationObserver((mutationList) => {
            for (const mutation of mutationList) {
                if (mutation.type === "childList") {
                    for (const node of mutation.addedNodes) {
                        updateMarkmaps(node);
                    }
                }
            }
        });

        observer.observe(document.body, { childList: true });

        updateMarkmaps(document);
    });
})();
</script></body>
</html>